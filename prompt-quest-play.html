<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Quest - Playing</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-darkest: #0a0f1a;
            --bg-dark: #0f1629;
            --bg-chat: #1a2744;
            --accent: #667eea;
            --success: #4ade80;
            --warning: #fbbf24;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            background: var(--bg-darkest);
            color: var(--text-primary);
            display: flex;
        }

        /* Left: Chat Panel */
        .chat-panel {
            width: 400px;
            min-width: 360px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .chat-header {
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 20px;
            padding: 4px;
        }

        .host-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }

        .host-info h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .host-info p {
            font-size: 12px;
            color: var(--success);
        }

        .challenge-banner {
            display: none;
            padding: 14px 20px;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
            font-size: 13px;
        }

        .challenge-banner.visible { display: block; }

        .challenge-banner strong { color: var(--warning); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 90%;
            animation: fadeUp 0.3s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.host { align-self: flex-start; }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .msg-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .msg-bubble {
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 18px 18px 4px 18px;
        }

        .message.host .msg-bubble {
            background: var(--bg-chat);
            border-radius: 18px 18px 18px 4px;
        }

        .msg-bubble strong { color: var(--success); }
        .msg-bubble em { color: var(--warning); }

        .typing-indicator {
            display: none;
            padding: 0 20px;
            gap: 5px;
        }

        .typing-indicator.visible { display: flex; }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .chat-input {
            padding: 16px 20px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 14px 20px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: var(--accent);
        }

        .chat-input input::placeholder {
            color: rgba(255,255,255,0.4);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--success), #22c55e);
            color: #052e16;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .send-btn:hover { transform: scale(1.05); }

        /* Right: Preview Panel */
        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-darkest);
        }

        .preview-header {
            padding: 16px 24px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .score-display {
            background: rgba(250, 204, 21, 0.2);
            color: var(--warning);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: none;
        }

        .score-display.visible { display: block; }

        .preview-canvas {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #preview-container {
            width: 100%;
            height: 100%;
        }

        .preview-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .preview-info strong {
            color: var(--text-primary);
        }

        /* Scrollbar */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* Responsive */
        @media (max-width: 900px) {
            body { flex-direction: column; }
            .chat-panel { width: 100%; height: 60vh; min-width: unset; }
            .preview-panel { height: 40vh; }
        }
    </style>
</head>
<body>
    <div class="chat-panel">
        <div class="chat-header">
            <a href="prompt-quest.html" class="back-link">â†</a>
            <div class="host-avatar" id="host-avatar">ğŸŒ²</div>
            <div class="host-info">
                <h2 id="host-name">Fernie</h2>
                <p>Online â€¢ Ready to create</p>
            </div>
        </div>
        <div class="challenge-banner" id="challenge-banner">
            ğŸ¯ <strong>Goal:</strong> <span id="challenge-text"></span>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="typing-indicator" id="typing">
            <span></span><span></span><span></span>
        </div>
        <div class="chat-input">
            <div class="input-row">
                <input type="text" id="user-input" placeholder="Describe what you want to create..." />
                <button class="send-btn" id="send-btn">â¤</button>
            </div>
        </div>
    </div>

    <div class="preview-panel">
        <div class="preview-header">
            <span class="preview-title">Live Preview</span>
            <span class="score-display" id="score">â­ 0</span>
        </div>
        <div class="preview-canvas">
            <div id="preview-container"></div>
            <div class="preview-info" id="preview-info">
                Objects: <strong id="obj-count">0</strong>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js';
        import { AuthManager } from './src/portal/AuthManager.js';

        // Auth check
        if (!AuthManager.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        // Get world from URL
        const params = new URLSearchParams(window.location.search);
        const worldId = params.get('world') || 'forest';

        // World configurations
        const WORLDS = {
            forest: {
                name: 'Fernie',
                icon: 'ğŸŒ²',
                avatarBg: 'linear-gradient(135deg, #2d5a27, #1a3d17)',
                greeting: "Hey there, friend! âœ¨ I'm Fernie, spirit of the forest. Tell me what to grow and I'll make it happenâ€”but I take words pretty literally, so be specific!",
                objectName: 'trees',
                challenges: [
                    { goal: 'Create exactly 10 trees', target: { count: 10, tolerance: 2 } },
                    { goal: 'Build a dense forest of 50 trees', target: { count: 50, tolerance: 10, density: 'dense' } },
                    { goal: 'Make 25 trees in organized rows', target: { count: 25, tolerance: 5, arrangement: 'grid' } }
                ],
                spawn: (scene, count, params) => spawnTrees(scene, count, params)
            },
            character: {
                name: 'Pixel',
                icon: 'ğŸ§™',
                avatarBg: 'linear-gradient(135deg, #6366f1, #4f46e5)',
                greeting: "Greetings, creator! ğŸ¨ I'm Pixel, and I bring characters to life. Describe a hero, a villain, anyoneâ€”and watch them appear! The more detail, the better I understand.",
                objectName: 'characters',
                challenges: [
                    { goal: 'Create a single tall character', target: { count: 1, height: 'tall' } },
                    { goal: 'Make a group of 5 small figures', target: { count: 5, tolerance: 1, size: 'small' } },
                    { goal: 'Create 3 characters of different sizes', target: { count: 3, tolerance: 0, varied: true } }
                ],
                spawn: (scene, count, params) => spawnCharacters(scene, count, params)
            },
            room: {
                name: 'Deco',
                icon: 'ğŸ ',
                avatarBg: 'linear-gradient(135deg, #f59e0b, #d97706)',
                greeting: "Welcome to my studio! ğŸ›‹ï¸ I'm Deco, and I furnish spaces. Tell me what belongs in your roomâ€”furniture, decorations, vibesâ€”and I'll arrange it all!",
                objectName: 'items',
                challenges: [
                    { goal: 'Place 5 pieces of furniture', target: { count: 5, tolerance: 1 } },
                    { goal: 'Create a cozy corner with 8 items', target: { count: 8, tolerance: 2, density: 'dense' } }
                ],
                spawn: (scene, count, params) => spawnFurniture(scene, count, params)
            },
            creature: {
                name: 'Morph',
                icon: 'ğŸ‰',
                avatarBg: 'linear-gradient(135deg, #ef4444, #b91c1c)',
                greeting: "Mwahahaha! ğŸ§ª I'm Morph, creator of creatures! Describe a beastâ€”any beastâ€”and I'll bring it to life. The weirder, the better!",
                objectName: 'creatures',
                challenges: [
                    { goal: 'Summon a single large creature', target: { count: 1, size: 'large' } },
                    { goal: 'Create a pack of 6 small creatures', target: { count: 6, tolerance: 1, size: 'small' } }
                ],
                spawn: (scene, count, params) => spawnCreatures(scene, count, params)
            }
        };

        const world = WORLDS[worldId] || WORLDS.forest;
        
        // Update UI with world info
        document.getElementById('host-name').textContent = world.name;
        document.getElementById('host-avatar').textContent = world.icon;
        document.getElementById('host-avatar').style.background = world.avatarBg;
        document.title = `Prompt Quest - ${world.name}`;

        // Game state
        let score = 0;
        let promptCount = 0;
        let challengeIndex = -1;
        let currentChallenge = null;
        let objects = [];

        // Three.js setup
        const container = document.getElementById('preview-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);

        const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 500);
        camera.position.set(40, 25, 40);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(1);
        container.appendChild(renderer.domElement);

        // Lighting
        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 0.8);
        directional.position.set(50, 50, 25);
        scene.add(directional);

        // Ground
        const groundGeo = new THREE.CircleGeometry(50, 32);
        const groundMat = new THREE.MeshLambertMaterial({ color: 0x2d4a3e });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // Animation loop
        let angle = 0;
        function animate() {
            requestAnimationFrame(animate);
            angle += 0.003;
            camera.position.x = Math.cos(angle) * 50;
            camera.position.z = Math.sin(angle) * 50;
            camera.lookAt(0, 5, 0);
            renderer.render(scene, camera);
        }
        animate();

        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SPAWN FUNCTIONS FOR DIFFERENT WORLDS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function clearObjects() {
            objects.forEach(obj => scene.remove(obj));
            objects = [];
        }

        function spawnTrees(scene, count, params) {
            clearObjects();
            const trunkGeo = new THREE.CylinderGeometry(0.3, 0.5, 2, 6);
            const trunkMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const foliageGeo = new THREE.ConeGeometry(1.5, 4, 6);
            const foliageMat = new THREE.MeshLambertMaterial({ color: 0x228B22 });

            for (let i = 0; i < count; i++) {
                const x = (Math.random() - 0.5) * 60;
                const z = (Math.random() - 0.5) * 60;
                const scale = 0.7 + Math.random() * 0.6;

                const trunk = new THREE.Mesh(trunkGeo, trunkMat);
                trunk.position.set(x, 1, z);
                trunk.scale.setScalar(scale);
                scene.add(trunk);
                objects.push(trunk);

                const foliage = new THREE.Mesh(foliageGeo, foliageMat);
                foliage.position.set(x, 3.5 * scale, z);
                foliage.scale.setScalar(scale);
                scene.add(foliage);
                objects.push(foliage);
            }
            updateCount(count);
        }

        function spawnCharacters(scene, count, params) {
            clearObjects();
            const bodyGeo = new THREE.CapsuleGeometry(0.5, 1.5, 4, 8);
            const headGeo = new THREE.SphereGeometry(0.4, 8, 8);

            for (let i = 0; i < count; i++) {
                const x = (Math.random() - 0.5) * 40;
                const z = (Math.random() - 0.5) * 40;
                const scale = 0.6 + Math.random() * 0.8;
                const hue = Math.random();
                const color = new THREE.Color().setHSL(hue, 0.6, 0.5);
                const mat = new THREE.MeshLambertMaterial({ color });

                const body = new THREE.Mesh(bodyGeo, mat);
                body.position.set(x, 1.25 * scale, z);
                body.scale.setScalar(scale);
                scene.add(body);
                objects.push(body);

                const head = new THREE.Mesh(headGeo, mat);
                head.position.set(x, 2.5 * scale, z);
                head.scale.setScalar(scale);
                scene.add(head);
                objects.push(head);
            }
            updateCount(count);
        }

        function spawnFurniture(scene, count, params) {
            clearObjects();
            const types = [
                { geo: new THREE.BoxGeometry(2, 0.8, 1), color: 0x8B4513, y: 0.4 }, // table
                { geo: new THREE.BoxGeometry(1, 1.2, 1), color: 0x4a5568, y: 0.6 }, // chair
                { geo: new THREE.CylinderGeometry(0.3, 0.3, 1.5, 8), color: 0xd4a574, y: 0.75 }, // lamp
                { geo: new THREE.BoxGeometry(0.8, 0.4, 0.8), color: 0x2d3748, y: 0.2 }, // ottoman
            ];

            for (let i = 0; i < count; i++) {
                const type = types[Math.floor(Math.random() * types.length)];
                const x = (Math.random() - 0.5) * 30;
                const z = (Math.random() - 0.5) * 30;
                const mat = new THREE.MeshLambertMaterial({ color: type.color });
                const mesh = new THREE.Mesh(type.geo, mat);
                mesh.position.set(x, type.y, z);
                mesh.rotation.y = Math.random() * Math.PI * 2;
                scene.add(mesh);
                objects.push(mesh);
            }
            updateCount(count);
        }

        function spawnCreatures(scene, count, params) {
            clearObjects();
            for (let i = 0; i < count; i++) {
                const x = (Math.random() - 0.5) * 40;
                const z = (Math.random() - 0.5) * 40;
                const scale = 0.5 + Math.random() * 1.5;
                const hue = Math.random();
                const color = new THREE.Color().setHSL(hue, 0.7, 0.4);
                const mat = new THREE.MeshLambertMaterial({ color });

                // Body
                const bodyGeo = new THREE.SphereGeometry(1, 8, 6);
                const body = new THREE.Mesh(bodyGeo, mat);
                body.position.set(x, scale, z);
                body.scale.set(scale, scale * 0.7, scale);
                scene.add(body);
                objects.push(body);

                // Eyes
                const eyeMat = new THREE.MeshLambertMaterial({ color: 0xffffff });
                const eyeGeo = new THREE.SphereGeometry(0.2, 6, 6);
                const eye1 = new THREE.Mesh(eyeGeo, eyeMat);
                eye1.position.set(x - 0.3 * scale, scale * 1.2, z + 0.8 * scale);
                scene.add(eye1);
                objects.push(eye1);

                const eye2 = new THREE.Mesh(eyeGeo, eyeMat);
                eye2.position.set(x + 0.3 * scale, scale * 1.2, z + 0.8 * scale);
                scene.add(eye2);
                objects.push(eye2);
            }
            updateCount(count);
        }

        function updateCount(n) {
            document.getElementById('obj-count').textContent = n;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROMPT PARSING (simplified for game)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function parsePrompt(text) {
            const lower = text.toLowerCase();
            let count = 25; // default

            // Extract numbers
            const numMatch = lower.match(/(\d+)/);
            if (numMatch) count = Math.min(parseInt(numMatch[1]), 200);

            // Quantifier words
            if (/\b(a|one|single)\b/.test(lower) && !/\d/.test(lower)) count = 1;
            else if (/\bfew\b/.test(lower)) count = Math.floor(Math.random() * 8) + 3;
            else if (/\bsome\b/.test(lower)) count = Math.floor(Math.random() * 15) + 10;
            else if (/\bseveral\b/.test(lower)) count = Math.floor(Math.random() * 10) + 15;
            else if (/\bmany\b/.test(lower)) count = Math.floor(Math.random() * 40) + 40;
            else if (/\blots?\b/.test(lower)) count = Math.floor(Math.random() * 50) + 50;

            // Specificity score
            let specificity = 0;
            if (/\d+/.test(lower)) specificity += 40;
            else if (/few|some|several|many|lot/.test(lower)) specificity += 20;
            if (/big|large|tall|small|tiny|huge/.test(lower)) specificity += 20;
            if (/grid|row|cluster|circle|scatter|random|organized/.test(lower)) specificity += 20;
            if (/dense|sparse|spread|packed/.test(lower)) specificity += 20;

            return { count, specificity: Math.min(specificity, 100) };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHAT SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing');

        function addMessage(type, text) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            
            const avatar = type === 'host' ? world.icon : 'ğŸ‘¤';
            const avatarStyle = type === 'host' ? `background: ${world.avatarBg}` : 'background: #667eea';
            
            msg.innerHTML = `
                <div class="msg-avatar" style="${avatarStyle}">${avatar}</div>
                <div class="msg-bubble">${formatText(text)}</div>
            `;
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function formatText(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        async function showTyping(ms) {
            typingIndicator.classList.add('visible');
            chatMessages.scrollTop = chatMessages.scrollHeight;
            await delay(ms);
            typingIndicator.classList.remove('visible');
        }

        function delay(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        function randomChoice(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GAME LOGIC
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;
            
            userInput.value = '';
            promptCount++;
            addMessage('user', text);

            // Check for commands
            const lower = text.toLowerCase();
            if (lower.includes('hint') || lower.includes('help')) {
                await giveHint();
                return;
            }
            if (lower.includes('challenge') || lower.includes('ready') || lower.includes('next')) {
                await startChallenge();
                return;
            }

            // Parse and respond
            const result = parsePrompt(text);
            await respondToPrompt(text, result);
        }

        async function respondToPrompt(text, result) {
            await showTyping(600 + Math.random() * 500);

            // Respond based on specificity
            if (result.specificity < 20) {
                const responses = [
                    `"${text.split(' ').slice(0, 3).join(' ')}..." Hmm, that's pretty vague! I'll just wing it... ğŸ²`,
                    `Creative freedom! I love it... or do I? Let's see what happens!`,
                    `*scratches head* That could mean anything! Here's my interpretation:`,
                ];
                addMessage('host', randomChoice(responses));
            } else if (result.specificity < 50) {
                addMessage('host', randomChoice([
                    `Okay, I think I understand... Let me try!`,
                    `Getting there! Here's what I came up with:`,
                    `Not bad! I have a decent picture now.`,
                ]));
            } else {
                addMessage('host', randomChoice([
                    `**Now** we're talking! Crystal clear! âœ¨`,
                    `Ooh, I love specifics! Watch this:`,
                    `Perfect instructions! Coming right up! ğŸ¯`,
                ]));
            }

            // Spawn objects
            await delay(300);
            world.spawn(scene, result.count, result);

            // Describe result
            await showTyping(400);
            addMessage('host', `Done! Created **${result.count} ${world.objectName}** for you.`);

            // Check challenge
            if (currentChallenge) {
                await checkChallenge(result);
            }
        }

        async function startChallenge() {
            challengeIndex++;
            if (challengeIndex >= world.challenges.length) {
                await showTyping(500);
                addMessage('host', `ğŸ‰ **You've completed all challenges!** Final score: **${score} points**. You're a prompt engineering pro!`);
                return;
            }

            currentChallenge = world.challenges[challengeIndex];
            promptCount = 0;

            await showTyping(500);
            addMessage('host', `ğŸ¯ **Challenge ${challengeIndex + 1}:** ${currentChallenge.goal}`);
            
            document.getElementById('challenge-banner').classList.add('visible');
            document.getElementById('challenge-text').textContent = currentChallenge.goal;
        }

        async function checkChallenge(result) {
            const target = currentChallenge.target;
            const diff = Math.abs(result.count - target.count);
            
            if (diff <= (target.tolerance || 0)) {
                // Success!
                const bonus = Math.max(0, 100 - (promptCount - 1) * 25);
                const points = 100 + bonus;
                score += points;
                
                await delay(500);
                await showTyping(500);
                
                if (promptCount === 1) {
                    addMessage('host', `ğŸ‰ **Perfect!** First try! You're amazing! (+${points} points)`);
                } else {
                    addMessage('host', `ğŸ‰ **Nailed it!** Took ${promptCount} tries but you got there! (+${points} points)`);
                }
                
                document.getElementById('score').textContent = `â­ ${score}`;
                document.getElementById('score').classList.add('visible');
                document.getElementById('challenge-banner').classList.remove('visible');
                currentChallenge = null;

                await delay(500);
                addMessage('host', `Say **"next"** when you're ready for another challenge!`);
            } else {
                // Not quite
                await delay(300);
                await showTyping(400);
                if (result.count < target.count) {
                    addMessage('host', `Hmm, that's fewer than I was hoping for. Try again?`);
                } else {
                    addMessage('host', `Whoa, that's more than expected! Want to try again?`);
                }
            }
        }

        async function giveHint() {
            await showTyping(400);
            if (currentChallenge) {
                addMessage('host', `ğŸ’¡ **Hint:** Try being more specific about the *exact number* you want. Words like "exactly" or using numbers helps!`);
            } else {
                addMessage('host', `ğŸ’¡ **Tip:** The more specific you are, the better I understand! Try mentioning numbers, sizes, or arrangements.`);
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSend();
        });

        // Start with greeting
        setTimeout(async () => {
            await showTyping(800);
            addMessage('host', world.greeting);
            await delay(500);
            await showTyping(400);
            addMessage('host', `Try describing what you want, or say **"challenge"** to test your skills!`);
        }, 500);
    </script>
</body>
</html>
